const core = require(`@actions/core`);
const github = require(`@actions/github`);

// get alert data from https://developer.github.com/v4/object/repositoryvulnerabilityalert/
async function getVulnerabilities(context) {
  var octokit = new github.GitHub(process.env.GITHUB_TOKEN);
  var query = `
  query {
    repository(owner:"${context.payload.repository.owner.login}",name:"${context.payload.repository.name}") {
      vulnerabilityAlerts(first:100) {
        totalCount,
        nodes {
          securityVulnerability {
            advisory {
              description
              identifiers {
                type
                value
              }
              references {
                url
              }
              severity
              summary
            }
            firstPatchedVersion {
              identifier
            }
            package {
              name
              ecosystem
            }
            severity
            updatedAt
            vulnerableVersionRange
          }
          repository {
            nameWithOwner
          }
          vulnerableManifestFilename
          vulnerableManifestPath
          vulnerableRequirements
        }
      }
    }
  }
  `
  try {
    return await octokit.graphql(query, {headers: {authorization: `token ${process.env.GITHUB_TOKEN}`}});
  } catch (error) {
    throw error
  }
}

try {
  console.log(`Running`);
  core.setOutput(`id`, (new Date()).toTimeString()); //TBD: actual Work Item ID
  const context = github.context
  if(context.eventName==`pull_request` && context.actor==`dependabot[bot]` && context.payload.pull_request.title.startsWith(`Bump `)) {
    const [ ,dep_name, ,version_from, , version_to] = context.payload.pull_request.title.split(` `);
    console.log(`Searching for Vulnerability Alerts with package name "${dep_name}" to patch to "${version_to}"`);
    getVulnerabilities(context).then(vulnerabilities => {
      var vulnerability = undefined;
      vulnerabilities.repository.vulnerabilityAlerts.nodes.forEach(n => {
        console.log(`Found package name "${n.securityVulnerability.package.name}" to patch to "${n.securityVulnerability.firstPatchedVersion.identifier}"`);
        if(n.securityVulnerability.package.name==dep_name && n.securityVulnerability.firstPatchedVersion.identifier==version_to) {
          vulnerability = n.securityVulnerability;
        }
      });
      if(vulnerability) {
        // TBD: create Issue via https://docs.microsoft.com/en-us/rest/api/azure/devops/?view=azure-devops-rest-5.1
        console.log(`TBD: create issue with...
        Title: ${context.payload.pull_request.title}
        Severity: ${vulnerability.severity}
        Description: ${vulnerability.advisory.description}
        `);
      } else {
        console.log(`No matching vulnerabilities found:
        ${JSON.stringify(vulnerabilities,undefined,2)}
        `)
      }
    }).catch(error => {
      core.setFailed(error.message);
    });
  } else {
    console.log(`This is not a Pull Request generated by Dependabot...
    Event: ${context.eventName}
    Actor: ${context.actor}
    Title: ${context.payload.pull_request.title}
    `)
  }
} catch (error) {
  core.setFailed(error.message);
}