import { debug, setOutput, setFailed } from `@actions/core`;
import { context } from `@actions/github`;
import { octokit } from `@octokit/action`;

// get alert data from https://developer.github.com/v4/object/repositoryvulnerabilityalert/
async function getVulnerabilities(context) {
  var owner = context.payload.repository.owner.login;
  var repo = context.payload.repository.name;
  debug(`owner: ${owner}`);
  debug(`repo: ${repo}`);
  var query = `
  repository(owner:${owner},name:${repo}) {
    vulnerabilityAlerts(first:100) {
      totalCount,
      nodes {
        securityVulnerability {
          advisory {
            description
            identifiers {
              type
              value
            }
            references {
              url
            }
            severity
            summary
          }
          firstPatchedVersion {
            identifier
          }
          package {
            name
            ecosystem
          }
          severity
          updatedAt
          vulnerableVersionRange
        }
        repository {
          nameWithOwner
        }
        vulnerableManifestFilename
        vulnerableManifestPath
        vulnerableRequirements
      }
    }
  };`
  try {
    return await new octokit().graphql(query, {headers: {authorization: `token ${process.env.GITHUB_TOKEN}`}});
  } catch (error) {
    throw error
  }
}

try {
  debug(`Running`);
  setOutput(`id`, (new Date()).toTimeString()); //TBD: actual Work Item ID
  if(context.eventName==`pull_request` && context.actor==`dependabot[bot]` && context.payload.pull_request.title.startsWith(`Bump `)) {
    const [ ,dep_name, ,version_from, , version_to] = context.payload.pull_request.title.split(` `);
    debug(`dep_name: ${dep_name}`);
    debug(`version_from: ${version_from}`);
    debug(`version_to: ${version_to}`);
    getVulnerabilities(context).then(vulnerabilities => {
      debug(`vulnerabilities: ${vulnerabilities}`);
    }).catch(error => {
      setFailed(error.message);
    });
  }
  // TBD: create Issue via https://docs.microsoft.com/en-us/rest/api/azure/devops/?view=azure-devops-rest-5.1
} catch (error) {
  setFailed(error.message);
}